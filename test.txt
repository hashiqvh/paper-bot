"use client";

import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from "@/components/ui/tabs";
import { useAuth } from "@/contexts/AuthContext";
import { useExpenseCategories } from "@/contexts/ExpenseCategoriesContext";
import {
  useCompany,
  useCreateWallet,
  useDeleteSignature,
  useDeleteWallet,
  useNotificationPreferences,
  usePaymentInstructions,
  useProfile,
  useSystemSettings,
  useUpdate2FA,
  useUpdateCompany,
  useUpdateNotificationPreferences,
  useUpdatePassword,
  useUpdatePaymentInstructions,
  useUpdateProfile,
  useUpdateSystemSettings,
  useUpdateWallet,
  useUploadSignature,
  useWallets,
} from "@/hooks/useSettings";
import {
  companySchema,
  passwordSchema,
  paymentInstructionsSchema,
  profileSchema,
  systemSettingsSchema,
  walletSchema,
  type CompanyData,
  type NotificationPreferencesData,
  type PasswordData,
  type PaymentInstructionsData,
  type ProfileData,
  type SystemSettingsData,
  type WalletData,
} from "@/lib/validations/settings";
import { zodResolver } from "@hookform/resolvers/zod";
import {
  Check,
  Copy,
  PenTool,
  Plus,
  Trash2,
  Upload,
  X,
} from "lucide-react";
import { useEffect, useRef, useState } from "react";
import { useForm } from "react-hook-form";
import { toast } from "sonner";

export default function Settings() {
  const { user } = useAuth();
  const {
    categories: expenseCategories,
    addCategory,
    removeCategory,
  } = useExpenseCategories();
  const signatureInputRef = useRef<HTMLInputElement>(null);

  // API hooks
  const { data: profileData } = useProfile();
  const updateProfileMutation = useUpdateProfile();
  const updatePasswordMutation = useUpdatePassword();
  const update2FAMutation = useUpdate2FA();
  const { data: companyData, refetch: refetchCompany } = useCompany();
  const updateCompanyMutation = useUpdateCompany();
  const { data: walletsData, refetch: refetchWallets } = useWallets();
  const createWalletMutation = useCreateWallet();
  const deleteWalletMutation = useDeleteWallet();
  const updateWalletMutation = useUpdateWallet();
  const { data: paymentInstructionsData, refetch: refetchPaymentInstructions } = usePaymentInstructions();
  const updatePaymentInstructionsMutation = useUpdatePaymentInstructions();
  const { data: notificationPreferencesData, refetch: refetchNotifications } = useNotificationPreferences();
  const updateNotificationPreferencesMutation = useUpdateNotificationPreferences();
  const { data: systemSettingsData, refetch: refetchSystemSettings } = useSystemSettings();
  const updateSystemSettingsMutation = useUpdateSystemSettings();
  const uploadSignatureMutation = useUploadSignature();
  const deleteSignatureMutation = useDeleteSignature();

  // Forms
  const profileForm = useForm<ProfileData>({
    resolver: zodResolver(profileSchema),
    defaultValues: {
      name: user?.name || "",
      email: user?.email || "",
      phone: "",
      timezone: "UTC",
    },
  });

  const passwordForm = useForm<PasswordData>({
    resolver: zodResolver(passwordSchema),
    defaultValues: {
      currentPassword: "",
      newPassword: "",
      confirmPassword: "",
    },
  });

  const companyForm = useForm<CompanyData>({
    resolver: zodResolver(companySchema),
    defaultValues: {
      name: "",
      licenseNumber: "",
      address: "",
      supportEmail: "",
      supportPhone: "",
    },
  });

  const walletForm = useForm<WalletData>({
    resolver: zodResolver(walletSchema),
    defaultValues: {
      label: "",
      cryptocurrency: "",
      address: "",
      isPrimary: false,
    },
    mode: "onChange",
  });

  const paymentInstructionsForm = useForm<PaymentInstructionsData>({
    resolver: zodResolver(paymentInstructionsSchema),
    defaultValues: {
      instructions: "",
    },
  });

  const systemSettingsForm = useForm<SystemSettingsData>({
    resolver: zodResolver(systemSettingsSchema),
    defaultValues: {
      taxEnabled: false,
      vatRate: 20,
    },
  });

  // Data loading
  useEffect(() => {
    if (profileData?.user) {
      profileForm.reset({
        name: profileData.user.name,
        email: profileData.user.email,
        phone: profileData.user.phone || "",
        timezone: profileData.user.timezone || "UTC",
      });
    }
  }, [profileData, profileForm]);

  useEffect(() => {
    if (user?.role === "ADMIN") {
      refetchCompany();
      refetchWallets();
      refetchPaymentInstructions();
      refetchSystemSettings();
    }
    refetchNotifications();
  }, [user?.role]);

  useEffect(() => {
    if (companyData?.company) {
      companyForm.reset({
        name: companyData.company.name,
        licenseNumber: companyData.company.licenseNumber || "",
        address: companyData.company.address || "",
        supportEmail: companyData.company.supportEmail || "",
        supportPhone: companyData.company.supportPhone || "",
      });
    }
  }, [companyData]);

  useEffect(() => {
    if (paymentInstructionsData?.instructions) {
      paymentInstructionsForm.reset({
        instructions: paymentInstructionsData.instructions,
      });
    }
  }, [paymentInstructionsData]);

  useEffect(() => {
    if (systemSettingsData?.settings) {
      const settings = systemSettingsData.settings;
      systemSettingsForm.reset({
        taxEnabled: settings.taxEnabled ?? false,
        vatRate: settings.taxEnabled ? (settings.vatRate ?? 20) : undefined,
      });
    }
  }, [systemSettingsData]);

  const [signature, setSignature] = useState<string | null>(
    profileData?.user?.signature || null,
  );

  useEffect(() => {
    if (profileData?.user?.signature) {
      setSignature(profileData.user.signature);
    }
  }, [profileData]);

  const wallets = walletsData?.wallets || [];
  const [copiedId, setCopiedId] = useState<string | null>(null);
  const [newCategory, setNewCategory] = useState("");

  // Handlers (wallets, categories, signature)
  const handleAddWallet = async (data: WalletData) => {
    try {
      await createWalletMutation.mutateAsync({
        ...data,
        isPrimary: wallets.length === 0,
      });
      walletForm.reset();
      toast.success("Wallet added successfully");
    } catch (error: any) {
      toast.error(error.message || "Failed to add wallet");
    }
  };

  const handleDeleteWallet = async (id: string) => {
    try {
      await deleteWalletMutation.mutateAsync(id);
      toast.success("Wallet removed");
    } catch (error: any) {
      toast.error(error.message || "Failed to delete wallet");
    }
  };

  const handleSetPrimary = async (id: string) => {
    try {
      await updateWalletMutation.mutateAsync({
        id,
        data: { isPrimary: true },
      });
      toast.success("Primary wallet updated");
    } catch (error: any) {
      toast.error(error.message || "Failed to update wallet");
    }
  };

  const handleCopyAddress = (address: string, id: string) => {
    navigator.clipboard.writeText(address);
    setCopiedId(id);
    toast.success("Address copied to clipboard");
    setTimeout(() => setCopiedId(null), 2000);
  };

  const handleAddCategory = () => {
    if (!newCategory.trim()) return toast.error("Please enter a category name");
    if (
      expenseCategories.some(
        (cat) => cat.name.toLowerCase() === newCategory.trim().toLowerCase()
      )
    )
      return toast.error("Category already exists");
    addCategory(newCategory);
    setNewCategory("");
    toast.success("Expense category added successfully");
  };

  const handleDeleteCategory = (id: string) => {
    const category = expenseCategories.find((c) => c.id === id);
    if (category?.isDefault) return toast.error("Cannot delete default categories");
    removeCategory(id);
    toast.success("Category removed");
  };

  const handleSignatureUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    if (!file.type.startsWith("image/")) return toast.error("Please upload an image file");
    if (file.size > 2 * 1024 * 1024) return toast.error("File must be < 2MB");

    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64 = reader.result as string;
      try {
        await uploadSignatureMutation.mutateAsync(base64);
        setSignature(base64);
        toast.success("Signature uploaded successfully");
      } catch (error: any) {
        toast.error(error.message || "Failed to upload signature");
      }
    };
    reader.readAsDataURL(file);
  };

  const handleRemoveSignature = async () => {
    try {
      await deleteSignatureMutation.mutateAsync();
      setSignature(null);
      if (signatureInputRef.current) signatureInputRef.current.value = "";
      toast.success("Signature removed");
    } catch (error: any) {
      toast.error(error.message || "Failed to remove signature");
    }
  };

  // ---------- UI ----------
  return (
    <div className="w-full h-[calc(100vh-100px)] overflow-y-auto pb-6 space-y-6">
      <div>
        <h1 className="text-lg font-semibold">Settings</h1>
        <p className="text-slate-600 mt-1 text-sm">
          Manage your account and system preferences
        </p>
      </div>

      <Tabs defaultValue="profile" className="w-full">
        <TabsList className="flex-wrap">
          <TabsTrigger value="profile">Profile</TabsTrigger>
          <TabsTrigger value="security">Security</TabsTrigger>
          <TabsTrigger value="notifications">Notifications</TabsTrigger>
          {user?.role === "ADMIN" && (
            <>
              <TabsTrigger value="company">Company</TabsTrigger>
              <TabsTrigger value="payment">Payment</TabsTrigger>
              <TabsTrigger value="system">System</TabsTrigger>
            </>
          )}
        </TabsList>

        {/* --- Profile Tab --- */}
        <TabsContent value="profile" className="space-y-6">
          {/* ... your existing Profile + Signature cards here (unchanged) ... */}
        </TabsContent>

        {/* --- Security Tab --- */}
        <TabsContent value="security" className="space-y-6">
          {/* ... your existing Security cards ... */}
        </TabsContent>

        {/* --- Notifications Tab --- */}
        <TabsContent value="notifications" className="space-y-6">
          {/* ... your existing Notification cards ... */}
        </TabsContent>

        {user?.role === "ADMIN" && (
          <>
            {/* --- Company Tab --- */}
            <TabsContent value="company" className="space-y-6">
              {/* ... company profile form ... */}
            </TabsContent>

            {/* --- Payment Tab --- */}
            <TabsContent value="payment" className="space-y-6">
              {/* ... wallet + payment instructions ... */}
            </TabsContent>

            {/* --- System Tab (fixed scroll) --- */}
            <TabsContent
              value="system"
              className="space-y-6 max-h-[75vh] overflow-y-auto pr-2"
            >
              {/* ... service catalog, expense categories, tax settings ... */}
            </TabsContent>
          </>
        )}
      </Tabs>
    </div>
  );
}
